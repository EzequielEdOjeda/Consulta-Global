<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="icono.png">
    <title>Consulta Global</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000000; /* Fondo negro */
            color: #f0f0f0; /* Color de texto claro */
            display: flex;
            flex-direction: column; /* Layout en columna */
            align-items: center; /* Centrar horizontalmente */
            justify-content: flex-start; /* Alinear al inicio, el centrado inicial se hace con posicionamiento absoluto */
            height: 100vh;
            overflow: hidden; /* Evitar scrollbars */
            position: relative; /* Necesario para posicionamiento absoluto de #header-content y otros elementos flotantes */
        }

        /* Contenedor principal para el título y controles */
        #header-content {
            position: absolute; /* Posicionamiento absoluto para centrar inicialmente */
            top: 50%; /* Centrar verticalmente */
            left: 50%; /* Centrar horizontalmente */
            transform: translate(-50%, -50%); /* Ajustar para centrar el elemento */
            display: flex;
            flex-direction: column; /* Por defecto en columna */
            align-items: center;
            /* Transición suave para el movimiento - Aumentada duración */
            transition: top 0.7s ease-in-out, transform 0.7s ease-in-out, margin-top 0.7s ease-in-out;
            z-index: 20; /* Asegurar que esté por encima del globo */
            background-color: transparent; /* Fondo completamente transparente */
            width: auto; /* Permitir que el ancho se ajuste al contenido */
            max-width: 95%; /* Evitar que se desborde en pantallas pequeñas */
            padding: 10px; /* Añadir padding para espacio en los bordes */
            box-sizing: border-box; /* Incluir padding en el ancho */
        }

        /* Estilo para el contenedor del título principal */
        #title-container {
            margin-bottom: 20px; /* Espacio entre título y buscador por defecto */
             /* Transición suave - Aumentada duración */
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            pointer-events: none; /* Permitir clics a través */
            text-align: center;
            flex-shrink: 0; /* Evitar que el título se encoja */
            opacity: 1; /* Visible by default */
            transform: translateY(0); /* Initial position */
        }

        #main-title {
            font-size: 2.5em; /* Título grande */
            font-weight: bold;
            color: #00ffff; /* Color cian llamativo */
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); /* Sutil brillo */
            margin: 0; /* Eliminar margen por defecto */
        }

        /* Estilo para el body cuando un país está seleccionado o buscador activo */
        body.controls-active #header-content {
            position: absolute; /* Mantener absoluto para que flote */
            top: -5px; /* Mover a 15px del borde superior (más arriba) */
            left: 50%; /* Mantener centrado horizontalmente */
            transform: translateX(-50%); /* Ajustar para centrar horizontalmente */
            margin-top: 0; /* Asegurar que no haya margen superior adicional */
            width: 95%; /* Usar ancho relativo cuando está activo */
        }

        /* Ocultar el título cuando los controles están activos */
        body.controls-active #title-container {
            opacity: 0;
            transform: translateY(-25px); /* Mover hacia arriba un poco más mientras se desvanece */
            pointer-events: none; /* Asegurar que no sea interactivo cuando está oculto */
        }

        /* Estilo para el contenedor del buscador */
        #controls {
            padding: 0; /* Eliminar padding */
            background-color: transparent; /* Fondo transparente */
            backdrop-filter: none; /* Eliminar blur */
            border-radius: 5px;
            box-shadow: none; /* Eliminar sombra */
            display: flex;
            gap: 10px;
            align-items: center;
            border: none; /* Eliminar borde */
            position: relative; /* Necesario para posicionar el dropdown (aunque ahora usamos modal) */
            /* La transición de posición se maneja en #header-content */
            width: 100%; /* Asegurar que ocupe el ancho disponible en el contenedor padre (#header-content) */
            justify-content: center; /* Centrar el contenido del controls div */
        }

        /* Estilo para el input del buscador principal */
        #search {
            padding: 12px 20px; /* Aumentar padding */
            border: 1px solid rgba(255, 255, 255, 0.3); /* Borde sutil */
            background-color: rgba(255, 255, 255, 0); /* Fondo completamente transparente al inicio */
            color: #f0f0f0;
            border-radius: 30px; /* Más redondeado */
            font-size: 1.1em; /* Fuente ligeramente más grande */
            outline: none; /* Eliminar outline por defecto */
            transition: background-color 0.3s ease, box-shadow 0.3s ease, width 0.3s ease, border-color 0.3s ease; /* Transiciones */
            width: 250px; /* Ancho inicial */
            text-align: center; /* Centrar texto */
            cursor: pointer; /* Indicar que es clickable */
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }

        #search::placeholder {
            color: #aaa;
            text-align: center; /* Centrar placeholder */
        }

         /* Ajustar alineación del texto cuando hay contenido */
         #search:not(:placeholder-shown) {
             text-align: left;
             /* Estilo de fondo cuando el input tiene texto - Aumentado opacidad */
             background-color: rgba(255, 255, 255, 0.3); /* Fondo un poco más visible */
         }

        /* Estilo para el input del buscador principal al enfocar */
        #search:focus {
            background-color: rgba(255, 255, 255, 0.4); /* Fondo aún más visible al enfocar */
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.8); /* Brillo cian al enfocar */
            border-color: #00ffff; /* Borde cian al enfocar */
            width: 300px; /* Expandir ancho al enfocar */
            text-align: left; /* Alinear texto a la izquierda al enfocar */
        }

        /* Ocultar el botón de restablecer vista */
        #reset-button {
            display: none;
        }

        #globe-container {
            flex-grow: 1; /* Ocupa el espacio restante */
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative; /* Necesario para posicionar el panel de info */
            overflow: hidden; /* Evita problemas de overflow del SVG */
        }

        #globe {
            /* Dejar que JS controle el tamaño basado en el contenedor */
            max-width: 100%;
            max-height: 100%;
            /* El cursor se establece en JS según la clase data-available */
        }

        /* Color de tierra por defecto para países NO en los datos */
        .land {
            fill: #444; /* Gris oscuro */
            stroke: #222; /* Bordes más oscuros */
            stroke-width: 0.4px;
            transition: fill 0.2s ease;
            cursor: default; /* Cursor por defecto para países no interactivos */
        }

        /* Color de tierra para países que SÍ están en los datos */
        .land.data-available {
            fill: #b8b8b8; /* Tierra gris más brillante */
            stroke: #444; /* Bordes ligeramente más claros */
            cursor: pointer; /* Cursor de puntero para países interactivos */
        }

        /* Efecto hover para países NO en los datos */
        .land:not(.data-available):hover {
             fill: #555; /* Gris oscuro ligeramente más claro en hover */
        }

        /* Efecto hover para países que SÍ están en los datos */
        .land.data-available:hover {
            fill: #cccccc; /* Gris más claro en hover */
        }

        /* Color del país seleccionado (anula el fill de data-available) */
        .land.selected {
            fill: #00ffff; /* Resaltado cian para el seleccionado */
             stroke: #fff;
             stroke-width: 0.6px;
        }

        /* Definir la apariencia del agua */
        .water {
             fill: #0077be; /* Azul vibrante */
             filter: url(#ocean-glow);
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 20, 0.8); /* Oscuro semi-transparente */
            backdrop-filter: blur(8px); /* Más blur */
            border: 1px solid rgba(255, 255, 255, 0.2); /* Borde ajustado para tema oscuro */
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 250px;
            z-index: 10;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out; /* Animación de salida más suave */
            color: #e0e0e0; /* Color de texto claro para panel oscuro */
            transform: translateY(10px);
            opacity: 0; /* Iniciar oculto */
            display: none; /* Iniciar oculto */
        }

        #info-panel.visible {
             opacity: 1;
             transform: translateY(0);
             display: block; /* Hacer visible */
        }

        /* Contenedor para el nombre del país y la hora local */
        #country-header {
            display: flex; /* Usar flexbox */
            justify-content: space-between; /* Espacio entre nombre y hora */
            align-items: center; /* Alinear verticalmente */
            margin-bottom: 5px; /* Espacio debajo del encabezado */
            border-bottom: 1px solid rgba(255, 255, 255, 0.3); /* Borde debajo */
            padding-bottom: 5px;
        }

        #country-name {
            margin: 0; /* Eliminar margen por defecto */
            font-size: 1.2em;
            color: #fff; /* Encabezado blanco */
        }

        /* Estilo para la hora local */
        #local-time {
            font-size: 0.9em;
            color: #00ffff; /* Color cian para la hora */
            font-weight: bold; /* Texto en negrita */
            margin: 0; /* Eliminar margen por defecto */
            text-align: right; /* Alinear hora a la derecha */
            padding: 2px 5px; /* Pequeño padding para el fondo */
            background-color: rgba(0, 255, 255, 0.1); /* Fondo semi-transparente cian */
            border-radius: 4px; /* Bordes redondeados */
        }

        /* Contenedor para la bandera */
        #flag-container {
            margin-bottom: 10px;
            text-align: center;
            height: 40px; /* Altura fija para bandera */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px; /* Added space above the flag */
        }
         /* Estilo para la imagen de la bandera */
         #flag-container img {
            max-width: 60px; /* Limitar ancho de bandera */
            max-height: 40px; /* Limitar altura de bandera */
            height: auto;
            border: 1px solid rgba(255,255,255,0.3); /* Borde ajustado para tema oscuro */
            background-color: rgba(255,255,255,0.1); /* Ligero fondo para banderas */
            object-fit: contain; /* Asegurar que se mantenga la relación de aspecto */
         }
         /* Estilo para placeholder/emoji de bandera */
         #flag-container span {
            font-size: 30px; /* Hacer los emojis de bandera más grandes */
         }

        /* Contenedor para enlaces generales del país */
        #links-container a {
            display: block;
            margin-bottom: 8px; /* Espaciado aumentado */
            color: #66bfff; /* Azul más claro para enlaces */
            text-decoration: none;
            font-size: 0.9em;
            word-wrap: break-word; /* Evitar que enlaces largos se desborden */
        }

        #links-container a:hover {
            text-decoration: underline;
            color: #99dfff; /* Aún más claro en hover */
        }

        /* Contenedor específico para provincias de Argentina */
        #argentina-provinces {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: none; /* Oculto por defecto */
        }

        /* Estilo para el contenedor del input de búsqueda de provincias */
        #province-search-container {
            margin-bottom: 10px; /* Espacio debajo del buscador */
            position: relative; /* Necesario para posicionar el dropdown */
        }

        #province-search-container label {
             display: block;
             margin-bottom: 5px;
             font-weight: bold;
             font-size: 0.9em;
             color: #ccc;
        }

        /* Estilo para el input del buscador de provincias */
        #province-search {
            width: calc(100% - 24px); /* Ajustar ancho para padding */
            padding: 10px 12px; /* Padding */
            border: 1px solid #555;
            border-radius: 3px;
            background-color: rgba(0,0,0, 0.3);
            color: #f0f0f0;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer; /* Indicar que es clickable */
            box-sizing: border-box; /* Incluir padding y borde en el ancho */
        }

        /* Estilo para el input del buscador de provincias al enfocar */
        #province-search:focus {
             border-color: #007bff;
             box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        /* Contenedor para enlaces específicos de provincias */
        #province-links-container {
            min-height: 20px; /* Asegurar espacio aunque no se muestre enlace inicialmente */
            margin-bottom: 10px; /* Espacio debajo del enlace de provincia */
        }

        #province-links-container a {
            display: block;
            margin-bottom: 8px;
            color: #66bfff;
            text-decoration: none;
            font-size: 0.9em;
            word-wrap: break-word;
        }

        #province-links-container a:hover {
            text-decoration: underline;
            color: #99dfff;
        }

        /* Contenedor nacionales (siempre visible cuando Argentina está seleccionada) */
        .national-links h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1em;
            color: #ddd;
        }

        .national-links a {
            display: block;
            margin-bottom: 8px;
            color: #66bfff;
            text-decoration: none;
            font-size: 0.9em;
        }
        .national-links a:hover {
            text-decoration: underline;
            color: #99dfff;
        }

        /* Modal Background */
        #modal-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7); /* Semi-transparent black */
            z-index: 30; /* Above header and globe */
            display: none; /* Hidden by default */
            backdrop-filter: blur(5px); /* Optional blur effect */
            transition: opacity 0.3s ease; /* Add transition for fade */
            opacity: 0; /* Start transparent */
        }
        #modal-background.visible {
            display: block;
            opacity: 1;
        }


        /* Modal Container */
        #modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95); /* Start slightly smaller */
            background-color: rgba(30, 30, 30, 0.98); /* Darker, less transparent */
            border: 1px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            z-index: 40; /* Above modal background */
            display: none; /* Hidden by default */
            width: 90%; /* Responsive width */
            max-width: 400px; /* Max width */
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            gap: 15px;
            transition: opacity 0.3s ease, transform 0.3s ease; /* Add transition */
            opacity: 0; /* Start transparent */
        }
        #modal-container.visible {
             display: flex;
             opacity: 1;
             transform: translate(-50%, -50%) scale(1); /* Scale to normal size */
        }


        /* Modal Header */
        #modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        #modal-title {
            margin: 0;
            font-size: 1.3em;
            color: #fff;
        }

        #modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s ease;
        }

        #modal-close:hover {
            color: #ff0000; /* Red on hover */
        }

        /* Modal Search Input */
        #modal-search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1); /* Slightly visible background */
            color: #f0f0f0;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #modal-search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        /* Modal List Container (now uses .dropdown-list class) */
        #modal-list.dropdown-list {
            flex-grow: 1; /* Take available space */
            max-height: 200px; /* Max height before scroll */
            overflow-y: auto; /* Add scroll */
            display: flex;
            flex-direction: column;
            gap: 5px; /* Space between buttons */
            padding: 0; /* Remove padding added by .dropdown-list style */
            border: none; /* Remove border added by .dropdown-list style */
            background-color: transparent; /* Remove background added by .dropdown-list style */
            box-shadow: none; /* Remove shadow added by .dropdown-list style */
        }

        /* Style for buttons inside modal list (similar to previous dropdown buttons) */
        #modal-list.dropdown-list button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            color: #f0f0f0;
            background-color: transparent;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 1em;
            border-radius: 5px; /* Rounded corners for buttons */
        }

        #modal-list.dropdown-list button:hover {
            background-color: rgba(0, 123, 255, 0.4);
            color: #ffffff;
        }


        /* Ajustes responsivos */
        @media (max-width: 600px) {
            /* Ajustar #header-content para layout en columna en móviles */
            #header-content {
                /* Initial positioning remains the same */
                width: 95%; /* Usar un ancho relativo para empezar */
                padding: 10px; /* Asegurar padding */
                flex-direction: column; /* Título y buscador en columna */
                align-items: center; /* Centrar horizontalmente */
                max-width: 100%; /* Asegurar que no haya max-width que lo limite */
            }

            #title-container {
                margin-bottom: 10px; /* Espacio debajo del título */
                margin-right: 0; /* Eliminar margen a la derecha */
                text-align: center; /* Centrar texto del título */
                width: 100%; /* Ocupar todo el ancho disponible */
            }

            #main-title {
                font-size: 1.5em; /* Título más pequeño en pantallas pequeñas */
                white-space: normal; /* Permitir que el título se envuelva si es necesario */
                overflow: visible; /* Permitir que el contenido se muestre */
                text-overflow: clip; /* Evitar elipsis */
                max-width: 100%; /* Permitir que el título ocupe el ancho completo */
            }

            #controls {
                flex-direction: column; /* Asegurar que los elementos dentro de controls estén en columna */
                align-items: stretch; /* Estirar elementos para ocupar el ancho completo */
                gap: 5px; /* Reducir espacio entre elementos dentro de controls si los hubiera */
                width: 100%; /* Ocupar todo el ancho disponible */
                flex-grow: 0; /* No permitir que controls crezca */
                justify-content: center; /* Centrar el contenido de controls */
            }

            #search {
                 width: 100%; /* Ocupar todo el ancho disponible */
                 flex-grow: 0; /* No permitir que el input crezca */
                 max-width: none; /* Eliminar límite de ancho máximo */
                 font-size: 0.9em; /* Fuente ligeramente más pequeña */
                 padding: 8px 12px; /* Reducir padding */
                 text-align: center; /* Centrar texto por defecto en móvil */
            }
             #search::placeholder {
                 text-align: center; /* Centrar placeholder en móvil */
             }

            #search:focus {
                 width: 100%; /* Ocupar todo el ancho disponible al enfocar */
                 max-width: none; /* Eliminar límite de ancho máximo al enfocar */
                 text-align: left; /* Alinear texto a la izquierda al enfocar */
            }

            /* Ajuste para pantallas pequeñas cuando los controles están activos */
             body.controls-active #header-content {
                position: absolute; /* Mantener absoluto cuando está activo */
                top: 10px; /* Mover a 10px del borde superior en pantallas pequeñas */
                left: 50%; /* Mantener centrado horizontalmente */
                transform: translateX(-50%); /* Ajustar para centrar horizontalmente */
                width: 95%; /* Usar ancho relativo cuando está activo */
                flex-direction: column; /* Mantener en columna */
                align-items: center; /* Mantener alineación */
                justify-content: center; /* Centrar el buscador cuando está activo */
             }

             /* Asegurar que el título esté oculto cuando controls-active está en móvil */
             body.controls-active #title-container {
                 display: none; /* Ocultar completamente el título */
             }


            #info-panel {
                bottom: 10px; /* Ajustado para pantallas pequeñas */
                right: 10px; /* Ajustado para pantallas pequeñas */
                max-width: 180px;
                padding: 10px;
            }
            #info-panel h2 {
                font-size: 1em;
            }
            #flag-container {
                height: 30px;
            }
             #flag-container img {
                max-width: 45px;
                max-height: 30px;
             }
             #flag-container span {
                font-size: 24px;
             }
            #links-container a,
            #province-links-container a,
            #argentina-provinces label,
            #province-search,
            .national-links h3,
            .national-links a {
                font-size: 0.8em;
            }
        }

    </style>
    <script type="importmap">
        {
            "imports": {
                "d3": "https://cdn.jsdelivr.net/npm/d3@7/+esm",
                "topojson-client": "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm",
                "gsap": "https://cdn.jsdelivr.net/npm/gsap@3/+esm"
            }
        }
    </script>
</head>
<body>
    <div id="header-content">
        <div id="title-container">
            <h1 id="main-title">¿Dónde Voto?</h1>
        </div>
        <div id="controls">
            <input type="text" id="search" placeholder="Buscar país..." readonly>
            </div>
    </div>

    <div id="globe-container">
        <svg id="globe"></svg>
    </div>

    <div id="info-panel">
        <div id="country-header">
            <h2 id="country-name"></h2>
            <div id="local-time"></div>
        </div>
        <div id="flag-container"></div>
        <div style="text-align:center;" id="links-container"></div>

        <div id="argentina-provinces">
            <div id="province-search-container">
                <label for="province-search">Provincia:</label>
                <input type="text" id="province-search" placeholder="Escriba o seleccione..." readonly>
                </div>

            <div style="text-align:center;" id="province-links-container"></div>

			 <div style="text-align:center;" class="national-links">
                 <a href="https://infractores.padron.gob.ar/" target="_blank">Registro de Infractores</a>
            </div>
        </div>
    </div>

    <div id="modal-background"></div>
    <div id="modal-container">
        <div id="modal-header">
            <h3 id="modal-title"></h3>
            <button id="modal-close">×</button>
        </div>
        <input type="text" id="modal-search-input" placeholder="Buscar...">
        <div id="modal-list" class="dropdown-list">
            </div>
    </div>
    <script type="module">
        import * as d3 from 'd3';
        import * as topojson from 'topojson-client';
        import { gsap } from 'gsap';

        // --- Data ---

        // Data for countries including flag URLs and electoral links
        // Only countries in this list will be interactive and have data displayed.
        const countriesData = [
          { id: 32, name: "Argentina", nameEs: "Argentina", lat: -34.6037, lon: -58.3816, code: "AR", electoralUrl: "https://www.padron.gob.ar/", flagUrl: "https://flagcdn.com/w80/ar.png", timezone: "America/Argentina/Buenos_Aires" },
          { id: 840, name: "United States", nameEs: "Estados Unidos", lat: 37.0902, lon: -95.7129, code: "US", electoralUrl: "https://www.usa.gov/register-to-vote", flagUrl: "https://flagcdn.com/w80/us.png", timezone: "America/New_York" }, // Example timezone
          { id: 76, name: "Brazil", nameEs: "Brasil", lat: -15.7801, lon: -47.9292, code: "BR", electoralUrl: "https://www.tse.jus.br/eleitor/titulo-e-local-de-votacao/consulta-por-nome", flagUrl: "https://flagcdn.com/w80/br.png", timezone: "America/Sao_Paulo" }, // Example timezone
          { id: 124, name: "Canada", nameEs: "Canadá", lat: 56.1304, lon: -106.3468, code: "CA", electoralUrl: "https://www.elections.ca/content.aspx?section=vot&dir=reg&document=index&lang=e", flagUrl: "https://flagcdn.com/w80/ca.png", timezone: "America/Toronto" }, // Example timezone
          { id: 484, name: "Mexico", nameEs: "México", lat: 23.6345, lon: -102.5528, code: "MX", electoralUrl: "https://listanominal.ine.mx/", flagUrl: "https://flagcdn.com/w80/mx.png", timezone: "America/Mexico_City" }, // Example timezone
          { id: 826, name: "United Kingdom", nameEs: "Reino Unido", lat: 55.3781, lon: -3.4360, code: "GB", electoralUrl: "https://www.gov.uk/register-to-vote", flagUrl: "https://flagcdn.com/w80/gb.png", timezone: "Europe/London" },
          { id: 250, name: "France", nameEs: "Francia", lat: 46.2276, lon: 2.2137, code: "FR", electoralUrl: "https://www.service-public.fr/particuliers/vosdroits/R16396", flagUrl: "https://flagcdn.com/w80/fr.png", timezone: "Europe/Paris" },
          { id: 276, name: "Germany", nameEs: "Alemania", lat: 51.1657, lon: 10.4515, code: "DE", electoralUrl: "https://www.bundeswahlleiter.de/en/bundestagswahlen/2021.html", flagUrl: "https://flagcdn.com/w80/de.png", timezone: "Europe/Berlin" },
          { id: 724, name: "Spain", nameEs: "España", lat: 40.4637, lon: -3.7492, code: "ES", electoralUrl: "https://sede.ine.gob.es/consulta_electoral_elecciones", flagUrl: "https://flagcdn.com/w80/es.png", timezone: "Europe/Madrid" },
          { id: 380, name: "Italy", nameEs: "Italia", lat: 41.8719, lon: 12.5674, code: "IT", electoralUrl: "https://dait.interno.gov.it/elezioni", flagUrl: "https://flagcdn.com/w80/it.png", timezone: "Europe/Rome" },
          { id: 36, name: "Australia", nameEs: "Australia", lat: -25.2744, lon: 133.7751, code: "AU", electoralUrl: "https://www.aec.gov.au/check-enrolment/", flagUrl: "https://flagcdn.com/w80/au.png", timezone: "Australia/Sydney" }, // Example timezone
          { id: 392, name: "Japan", nameEs: "Japón", lat: 36.2048, lon: 138.2529, code: "JP", electoralUrl: "https://www.soumu.go.jp/senkyo/index.html", flagUrl: "https://flagcdn.com/w80/jp.png", timezone: "Asia/Tokyo" },
          { id: 356, name: "India", nameEs: "India", lat: 20.5937, lon: 78.9629, code: "IN", electoralUrl: "https://electoralsearch.in/", flagUrl: "https://flagcdn.com/w80/in.png", timezone: "Asia/Kolkata" }, // Corrected duplicate flagUrl
          { id: 156, name: "China", nameEs: "China", lat: 35.8617, lon: 104.1954, code: "CN", electoralUrl: "http://www.npc.gov.cn/englishnpc/c23934/column.shtml", flagUrl: "https://flagcdn.com/w80/cn.png", timezone: "Asia/Shanghai" }, // Example timezone
          { id: 643, name: "Russia", nameEs: "Rusia", lat: 61.5240, lon: 105.3188, code: "RU", electoralUrl: "http://www.cikrf.ru/", flagUrl: "https://flagcdn.com/w80/ru.png", timezone: "Europe/Moscow" }, // Corrected duplicate flagUrl
          { id: 710, name: "South Africa", nameEs: "Sudáfrica", lat: -30.5595, lon: 22.9375, code: "ZA", electoralUrl: "https://www.elections.org.za/pw/Voter/Voter-Information", flagUrl: "https://flagcdn.com/w80/za.png", timezone: "Africa/Johannesburg" },
          { id: 152, name: "Chile", nameEs: "Chile", lat: -35.6751, lon: -71.5430, code: "CL", electoralUrl: "https://consulta.servel.cl/", flagUrl: "https://flagcdn.com/w80/cl.png", timezone: "America/Santiago" },
          { id: 170, name: "Colombia", nameEs: "Colombia", lat: 4.5709, lon: -74.2973, code: "CO", electoralUrl: "https://wsp.registraduria.gov.co/censo/_censoResultado.php", flagUrl: "https://flagcdn.com/w80/co.png", timezone: "America/Bogota" },
          { id: 818, name: "Egypt", nameEs: "Egipto", lat: 26.8206, lon: 30.8025, code: "EG", electoralUrl: "https://www.elections.eg/", flagUrl: "https://flagcdn.com/w80/eg.png", timezone: "Africa/Cairo" },
          { id: 566, name: "Nigeria", nameEs: "Nigeria", lat: 9.0820, lon: 8.6753, code: "NG", electoralUrl: "https://inecnigeria.org/", flagUrl: "https://flagcdn.com/w80/ng.png", timezone: "Africa/Lagos" },
          // Países agregados: Bolivia, Paraguay, Uruguay
          { id: 68, name: "Bolivia", nameEs: "Bolivia", lat: -16.2902, lon: -63.5887, code: "BO", electoralUrl: "https://yoparticipo.oep.org.bo/", flagUrl: "https://flagcdn.com/w80/bo.png", timezone: "America/La_Paz" },
          { id: 600, name: "Paraguay", nameEs: "Paraguay", lat: -23.4425, lon: -58.4438, code: "PY", electoralUrl: "https://rcp.tsje.gov.py/", flagUrl: "https://flagcdn.com/w80/py.png", timezone: "America/Asuncion" },
          { id: 858, name: "Uruguay", nameEs: "Uruguay", lat: -32.5228, lon: -55.7658, code: "UY", electoralUrl: "https://aplicaciones.corteelectoral.gub.uy/buscadorpermanente/buscadores.buscadorpermanente.aspx", flagUrl: "https://flagcdn.com/w80/uy.png", timezone: "America/Montevideo" }
        ];

        // Data for Argentina provinces and their electoral links
        const argentinaProvincesData = {
          'buenos-aires': {
        name: 'Buenos Aires',
        url: 'https://dondevotociudad.gob.ar/'
      },
      'caba': {
        name: 'CABA',
        url: 'https://caba.padron.gov.ar/'
      },
      'catamarca': {
        name: 'Catamarca',
        url: 'https://www.eleccionescatamarca.gob.ar/'
      },
      'chaco': {
        name: 'Chaco',
        url: 'https://padron.electoralchaco.gob.ar/consulta'
      },
      'chubut': {
        name: 'Chubut',
        url: 'https://electoral.juschubut.gov.ar/'
      },
      'cordoba': {
        name: 'Córdoba',
        url: 'https://elepcba.com.ar/'
      },
      'corrientes': {
        name: 'Corrientes',
        url: 'https://www.juscorrientes.gov.ar/junta-electoral/'
      },
      'entre-rios': {
        name: 'Entre Ríos',
        url: 'https://www.tribunalelectoraler.gob.ar/'
      },
      'formosa': {
        name: 'Formosa',
        url: 'https://padron.formosa.gob.ar/'
      },
      'jujuy': {
        name: 'Jujuy',
        url: 'https://www.padronjujuy.gob.ar/'
      },
      'la-pampa': {
        name: 'La Pampa',
        url: 'https://electoral.justicialapampa.gob.ar/definitivo/atencion.aspx'
      },
      'la-rioja': {
        name: 'La Rioja',
        url: 'https://larioja.padron.gov.ar/'
      },
      'mendoza': {
        name: 'Mendoza',
        url: 'https://www.mendoza.gov.ar/padron/'
      },
      'misiones': {
        name: 'Misiones',
        url: 'https://www.electoralmisiones.gov.ar/'
      },
      'neuquen': {
        name: 'Neuquén',
        url: 'https://www.muninqn.gov.ar/padron/'
      },
      'rio-negro': {
        name: 'Río Negro',
        url: 'https://rionegro.padron.gov.ar/'
      },
      'salta': {
        name: 'Salta',
        url: 'https://www.electoralsalta.gob.ar/electores/consulta-lugar-votacion'
      },
      'san-juan': {
        name: 'San Juan',
        url: 'https://www.padron.gob.ar/'
      },
      'san-luis': {
        name: 'San Luis',
        url: 'https://sanluis.padron.gov.ar/'
      },
      'santa-cruz': {
        name: 'Santa Cruz',
        url: 'https://educacionsantacruz.gov.ar/juntaelectoral/'
      },
      'santa-fe': {
        name: 'Santa Fe',
        url: 'https://www.santafe.gov.ar/elecciones2025/consultaPadronDefinitivo/'
      },
      'santiago-del-estero': {
        name: 'Santiago del Estero',
        url: 'https://www.jussantiago.gov.ar/web/#/home'
      },
      'tucuman': {
        name: 'Tucumán',
        url: 'https://electoraltucuman.gob.ar/'
      },
      'tierra-del-fuego': {
        name: 'Tierra del Fuego',
        url: 'https://padron.justierradelfuego.gov.ar/elecciones/padron-definitivo'
      }
        };

        // --- DOM Elements ---
        const body = d3.select("body"); // Select body to toggle classes
        const svg = d3.select("#globe");
        const infoPanel = d3.select("#info-panel");
        const countryNameEl = d3.select("#country-name");
        const localTimeEl = d3.select("#local-time"); // New element for local time
        const flagContainer = d3.select("#flag-container"); // Flag container
        const linksContainer = d3.select("#links-container");
        const argentinaProvincesContainer = d3.select("#argentina-provinces");
        const provinceLinksContainer = d3.select("#province-links-container");
        const searchInput = d3.select("#search");
        const controlsDiv = d3.select("#controls"); // Main search container
        const globeContainer = d3.select("#globe-container");
        const provinceSearchInput = d3.select("#province-search");
        const provinceSearchContainer = d3.select("#province-search-container"); // Province search container
        const titleContainer = d3.select("#title-container"); // Title container
        const headerContentDiv = d3.select("#header-content"); // Container for title and controls

        // Modal Elements
        const modalBackground = d3.select("#modal-background");
        const modalContainer = d3.select("#modal-container");
        const modalTitle = d3.select("#modal-title");
        const modalCloseButton = d3.select("#modal-close");
        const modalSearchInput = d3.select("#modal-search-input");
        const modalList = d3.select("#modal-list"); // Now uses .dropdown-list class

        // --- Globe State ---
        let width, height, projection, path, graticule, sphere, zoom, drag;
        let topojsonFeatures;
        const initialScaleFactor = 0.9;
        // Initial rotation adjusted to show Americas
        const initialRotation = { x: 70, y: -25, z: 0 }; // Adjusted initial rotation
        let currentRotation = { ...initialRotation };
        let searchableCountries = []; // List of countries with data for search
        let selectedCountryId = null;
        let localTimeInterval = null; // Variable to store the time update interval
        let currentTween = null; // Variable to store the current GSAP tween

        // --- Globe Setup and Rendering ---

        // Function to set up globe dimensions and projection
        function setupGlobe() {
            const containerRect = globeContainer.node().getBoundingClientRect();
            width = containerRect.width;
            height = containerRect.height;
            width = Math.max(width, 300); // Ensure minimum size
            height = Math.max(height, 300);

            svg.attr("width", width).attr("height", height);

            const effectiveScale = Math.min(width, height) / 2 * initialScaleFactor;

            projection = d3.geoOrthographic()
                .scale(effectiveScale)
                .translate([width / 2, height / 2])
                .rotate([currentRotation.x, currentRotation.y, currentRotation.z]) // Use currentRotation
                .clipAngle(90);

            path = d3.geoPath().projection(projection);
            graticule = d3.geoGraticule10();

            // Zoom behavior (handled by GSAP)
            zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", null); // Zoom handled by GSAP

            // Drag behavior
            drag = d3.drag()
                .subject(() => {
                    // Kill any ongoing animation when starting drag
                    if (currentTween) {
                        currentTween.kill();
                        currentTween = null;
                    }
                    const r = projection.rotate();
                    const sensFactor = projection.scale() / effectiveScale;
                    const sens = 0.25 / Math.max(sensFactor, 0.5); // Adjust sensitivity based on scale
                    return { x: r[0] / sens, y: -r[1] / sens, sens: sens };
                })
                .on("start", (event) => {
                    // Prevent click event after drag starts
                    event.sourceEvent.stopPropagation();
                     // Hide info panel visuals if dragging starts while it's visible
                    if (infoPanel.classed("visible")) {
                         hideInfoPanel(); // Hide visuals, don't reset state yet
                    }
                })
                .on("drag", (event) => {
                    if (!event.active) return;
                    const rotate = projection.rotate();
                    const sens = event.subject.sens;
                    const newRotation = {
                        x: rotate[0] + event.dx * sens,
                        y: rotate[1] - event.dy * sens,
                        z: rotate[2]
                    };
                    newRotation.y = Math.max(-85, Math.min(85, newRotation.y)); // Limit vertical rotation
                    projection.rotate([newRotation.x, newRotation.y, newRotation.z]);
                    currentRotation = newRotation; // Update state
                    renderGlobe(); // Re-render
                });

            svg.call(drag);
            svg.call(zoom);
            svg.on("click", handleBackgroundClick); // Handle clicks on background/water

            // Clear previous SVG content
            svg.selectAll("*").remove();

            // Define SVG filters (subtle glow for water)
            const defs = svg.append("defs");
            const filter = defs.append("filter").attr("id", "ocean-glow");
            filter.append("feGaussianBlur").attr("stdDeviation", "1.5").attr("result", "coloredBlur"); // Reduced glow
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            // Add sphere (water)
            svg.append("path")
                .datum({type: "Sphere"})
                .attr("id", "sphere")
                .attr("class", "water");

            // Add graticule
            svg.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("fill", "none")
                .attr("stroke", "rgba(128,128,128,0.2)")
                .attr("stroke-width", 0.5);

            // Add group for land features
            svg.append("g").attr("class", "land-features");

            // Initial render
            renderGlobe();
        }

        // Function to render or update the globe
        function renderGlobe() {
            if (!path || !topojsonFeatures) return;

            // Update projection based on current state
            projection.scale(projection.scale());
            projection.rotate([currentRotation.x, currentRotation.y, currentRotation.z]);
            path = d3.geoPath().projection(projection);

            // Update sphere and graticule
            svg.select("#sphere").attr("d", path);
            svg.select(".graticule").attr("d", path);

            // Filter features (exclude Antarctica, ID '010')
            const filteredFeatures = topojsonFeatures.filter(d => d.id && d.id !== '010');

            // Bind data to land paths
            const land = svg.select(".land-features")
                .selectAll("path.land")
                .data(filteredFeatures, d => d.id); // Use country ID as key

            // Enter selection
            land.enter()
                .append("path")
                .attr("class", "land")
                .attr("d", path)
                .on("click", handleCountryClick) // Attach click handler
                .on("mouseover", function(event, d) {
                    // Apply hover effect only if data is available or if it's the selected country
                    if (getCountryInfo(d) || d3.select(this).classed("selected")) {
                        // Add hover styling if needed, e.g., d3.select(this).style('fill', 'darkgrey');
                    }
                 })
                .on("mouseout", function(event, d) {
                     // Remove hover styling if needed
                 })
                .append("title") // Tooltip
                 .text(d => getCountryInfo(d)?.nameEs || d.properties?.name || `ID: ${d.id}`); // Show Spanish name if available

            // Update selection
            land.merge(land)
                 .classed("data-available", d => !!getCountryInfo(d)) // Add class if country is in our data
                 .classed("selected", d => parseInt(d.id, 10) === selectedCountryId) // Apply 'selected' class, corrected ID comparison
                 .attr("d", path); // Update path

            // Exit selection
            land.exit().remove();
        }

        // --- Data Loading and Processing ---

        // Load TopoJSON data
        async function loadData() {
            try {
                const world = await d3.json("https://unpkg.com/world-atlas@2/countries-110m.json");
                topojsonFeatures = topojson.feature(world, world.objects.countries).features;

                // Prepare list of searchable countries (using Spanish names where available)
                // Only include countries present in our countriesData array
                searchableCountries = topojsonFeatures
                    .map(d => {
                        const info = getCountryInfo(d);
                        if (info) { // Only include if country info exists in our data
                            const name = info.nameEs || info.name; // Prioritize Spanish name
                            if (name) {
                                return { id: info.id, nameEs: name }; // Use numeric ID from countriesData
                            }
                        }
                        return null;
                    })
                    .filter(Boolean) // Remove null entries
                    .sort((a, b) => a.nameEs.localeCompare(b.nameEs)); // Sort alphabetically by Spanish name

                console.log("Data loaded and processed.");
                // Ensure controls-active class is not active initially
                body.classed("controls-active", false);
                setupGlobe(); // Set up the globe
            } catch (error) {
                console.error("Error loading or processing data:", error);
                globeContainer.html("<p style='color: red; text-align: center;'>Error al cargar los datos del globo.</p>");
            }
        }

        // Get country info from our custom countriesData array
        function getCountryInfo(topojsonFeature) {
            if (!topojsonFeature || !topojsonFeature.id) return null;
            const id = parseInt(topojsonFeature.id, 10); // Ensure ID is a number for matching
            return countriesData.find(c => c.id === id);
        }

        // --- Modal Functions ---

        // Show the modal
        function showModal(title, data, itemType) {
            modalTitle.text(title);
            modalList.html(''); // Clear previous list items
            modalSearchInput.property('value', ''); // Clear modal search input

            const listItems = modalList.selectAll("button")
                .data(data)
                .enter()
                .append("button")
                .text(d => d.nameEs || d.name); // Use nameEs for countries, name for provinces

            if (itemType === 'country') {
                listItems.attr("data-country-id", d => d.id) // Use numeric ID
                    .on("click", function() {
                        const countryIdAttr = d3.select(this).attr("data-country-id");
                        console.log("Modal country button clicked. Country ID:", countryIdAttr); // Debugging log
                        const countryName = d3.select(this).text();
                        searchInput.property("value", countryName); // Update main search input
                        hideModal(); // Hide modal first
                        selectCountry(parseInt(countryIdAttr, 10)); // Then select the country
                    });
            } else if (itemType === 'province') {
                 listItems.attr("data-province-code", d => d.code)
                    .on("click", function() {
                        const provinceCode = d3.select(this).attr("data-province-code");
                        const provinceName = d3.select(this).text();
                        provinceSearchInput.property("value", provinceName); // Update province search input
                        hideModal();
                        updateProvinceLink(provinceCode); // Update the province link
                    });
            }

            // Filter modal list on input
            modalSearchInput.on("input", function() {
                const query = d3.select(this).property("value").trim().toLowerCase();
                modalList.selectAll("button").each(function() {
                    const button = d3.select(this);
                    const itemName = button.text().toLowerCase();
                    if (itemName.includes(query)) {
                        button.style("display", "block");
                    } else {
                        button.style("display", "none");
                    }
                });
            });

            // Use classes for modal visibility transitions
            modalBackground.classed("visible", true);
            modalContainer.classed("visible", true);
            modalSearchInput.node().focus(); // Focus modal search input

            // Ensure controls-active is set when modal is shown (triggered by focus/click)
            body.classed("controls-active", true);
        }

        // Hide the modal
        function hideModal() {
            // Use classes for modal visibility transitions
            modalBackground.classed("visible", false);
            modalContainer.classed("visible", false);

            // Clear list items after transition (optional, depends on desired effect)
            // setTimeout(() => {
            //     if (!modalContainer.classed("visible")) { // Check if still hidden
            //         modalList.html('');
            //         modalSearchInput.property('value', '');
            //     }
            // }, 300); // Match CSS transition duration

            // Do not change controls-active state here; let other functions manage it
        }


        // --- Interaction Functions ---

        // Handle click on a country feature
        function handleCountryClick(event, d) {
             event.stopPropagation(); // Prevent click from propagating to background

             // Check if the clicked country is in our data
             const countryInfo = getCountryInfo(d);
             if (!countryInfo) {
                 console.log("Clicked on a country not in data:", d.properties?.name || d.id);
                 // Do nothing to the current state if clicking non-data country
                 return;
             }

             // Ensure controls are active immediately when clicking a valid country
             body.classed("controls-active", true);


             if (d && d.id) {
                // If clicking the *same* selected country again, do nothing
                if (parseInt(d.id, 10) === selectedCountryId) {
                    console.log("Clicked same country again.");
                    return;
                }
                console.log("Clicked on country with data:", countryInfo.nameEs || countryInfo.name, "ID:", countryInfo.id); // Debugging log
                selectCountry(countryInfo.id); // Use numeric ID from countryInfo
                // Update search input with the selected country's name
                searchInput.property("value", countryInfo.nameEs || countryInfo.name);
             } else {
                console.warn("Clicked on invalid feature:", d);
                // Do nothing to the current state
             }
        }

        // Handle click on the globe background (water/space)
        function handleBackgroundClick(event) {
            // Check if the click was directly on the SVG or the water path
            if (event.target === svg.node() || event.target === svg.select("#sphere").node()) {
                resetView(); // Reset view if background is clicked
            }
        }

        // Select a country by ID, animate globe, and show info panel
        function selectCountry(countryId) {
             console.log("Attempting to select country ID:", countryId); // Debugging log at start

             // Ensure the country is in our data before proceeding
             const countryInfo = countriesData.find(c => c.id === countryId); // Find by numeric ID
             if (!countryInfo) {
                 console.warn("Attempted to select country not in data:", countryId); // Debugging log
                 // Do not change controls-active state here
                 return;
             }
             console.log("Country info found:", countryInfo.nameEs || countryInfo.name); // Debugging log

             // Apply controls-active immediately since a valid country is being selected
             body.classed("controls-active", true);

             // Find the corresponding TopoJSON feature using the numeric ID
             const countryFeature = topojsonFeatures.find(f => parseInt(f.id, 10) === countryId); // Corrected ID comparison
             if (!countryFeature) {
                 console.warn("Country feature not found for ID:", countryId); // Debugging log
                 updateInfoPanel(countryId); // Still show panel info if possible
                 // Controls active already set above
                 return; // Don't animate if feature not found
             }
             console.log("Country feature found:", countryFeature.properties.name); // Debugging log


             selectedCountryId = countryId; // Update state
             console.log("Selected:", countryInfo.nameEs || countryFeature.properties.name, "ID:", countryId); // Debugging log

             renderGlobe(); // Re-render to highlight

             // Calculate centroid and target view
             const centroid = d3.geoCentroid(countryFeature);
             console.log("Calculated centroid:", centroid); // Debugging log
             if (!centroid || !Array.isArray(centroid) || centroid.some(isNaN)) {
                 console.warn("Invalid centroid for country:", countryId, centroid); // Debugging log
                 updateInfoPanel(countryId); // Show info panel if possible
                 // Controls active already set above
                 return; // Don't animate if centroid is invalid
             }

             const targetRotation = { x: -centroid[0], y: -centroid[1] };
             const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
             const targetScale = baseScale * 2.5; // Zoom factor

             console.log("Animating to rotation:", targetRotation, "scale:", targetScale); // Debugging log
             // Animate rotation and scale
             rotateTo(targetRotation.x, targetRotation.y, targetScale, () => {
                 console.log("Animation complete callback."); // Debugging log
                 updateInfoPanel(countryId); // Update info panel *after* animation
                 // Controls active already set above
             });
        }

        // Animate globe rotation and scale using GSAP
        function rotateTo(lon, lat, scale, onCompleteCallback = null) {
            console.log("Animating to Lon:", lon, "Lat:", lat, "Scale:", scale);

            // Kill any existing tween before starting a new one
            if (currentTween) {
                currentTween.kill();
            }

            const currentScale = projection.scale();
            const currentRot = projection.rotate();

            const rotationProxy = { lon: currentRot[0], lat: currentRot[1], scale: currentScale };

            // Use GSAP to animate the proxy object
            currentTween = gsap.to(rotationProxy, {
                lon: lon,
                lat: lat,
                scale: scale,
                duration: 1.5, // Increased duration
                ease: "sine.inOut", // Smoother easing
                onUpdate: () => {
                     // Update projection during animation
                     currentRotation = { x: rotationProxy.lon, y: rotationProxy.lat, z: currentRotation.z };
                     projection.scale(rotationProxy.scale);
                    renderGlobe();
                },
                onComplete: () => {
                     console.log("GSAP Animation complete."); // Debugging log
                     // Ensure final state is set correctly
                     currentRotation = { x: lon, y: lat, z: currentRotation.z };
                     projection.scale(scale);
                    renderGlobe();
                    currentTween = null; // Clear the tween reference
                    if (onCompleteCallback) {
                        onCompleteCallback();
                    }
                }
            });
        }

        // Update info panel content
        function updateInfoPanel(countryId) {
            console.log("Updating info panel for ID:", countryId); // Debugging log

            // Ensure country is in our data before proceeding
            const countryInfo = countriesData.find(c => c.id === countryId);
            if (!countryInfo) {
                console.warn("Attempted to update info panel for country not in data:", countryId); // Debugging log
                hideInfoPanel(); // Hide panel visuals
                return;
            }
            console.log("Info panel country info:", countryInfo.nameEs || countryInfo.name); // Debugging log

            const countryName = countryInfo.nameEs || countryInfo.name || "País Desconocido";
            const countryCode = countryInfo.code; // Use code from data
            const timezone = countryInfo.timezone; // Get timezone

            countryNameEl.text(countryName);

            // --- Show Local Time ---
            clearInterval(localTimeInterval); // Clear previous interval if exists
            localTimeEl.text(''); // Clear previous time text

            if (timezone) {
                // Function to update time
                const updateTime = () => {
                    try {
                        const now = new Date();
                        const options = {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true, // 12-hour format (AM/PM)
                            timeZone: timezone
                        };
                        // Use Intl.DateTimeFormat for robust and localized time formatting
                        const formatter = new Intl.DateTimeFormat('es-ES', options);
                        localTimeEl.text(`${formatter.format(now)}`); // Just the time, no "Hora local:"
                    } catch (e) {
                        console.error("Error formatting time for timezone:", timezone, e); // Debugging log
                        localTimeEl.text(`N/A`); // Show N/A on error
                    }
                };

                updateTime(); // Show time immediately
                localTimeInterval = setInterval(updateTime, 60000); // Update every minute
            } else {
                localTimeEl.text(`N/A`); // Show N/A if no timezone
            }


            // --- Show Flag ---
            flagContainer.html(''); // Clear previous flag
            if (countryInfo.flagUrl) {
                // Try loading flag image
                flagContainer.append('img')
                    .attr('src', countryInfo.flagUrl)
                    .attr('alt', `Bandera de ${countryName}`)
                    .on('error', function() {
                        // If image fails, show fallback emoji
                        console.warn(`Flag image failed to load: ${countryInfo.flagUrl}`); // Debugging log
                        d3.select(this).remove(); // Remove broken image tag
                        flagContainer.append('span').text(getFlagEmoji(countryCode)); // Show emoji
                    });
            } else {
                // If no flag URL, show emoji directly
                console.log("No flag URL found, using emoji."); // Debugging log
                flagContainer.append('span').text(getFlagEmoji(countryCode));
            }

            // --- Show Links ---
            linksContainer.html(''); // Clear previous general links
            argentinaProvincesContainer.style("display", "none"); // Hide Argentina section by default
            provinceLinksContainer.html(''); // Clear province links
            provinceSearchInput.property('value', ''); // Clear province search input

            // Add general electoral link or search link
            if (countryInfo.electoralUrl) {
                 linksContainer.append("a")
                    .attr("href", countryInfo.electoralUrl)
                    .attr("target", "_blank")
                    .text(`Registro Electoral`); // Generic text
            } else {
                 // Provide generic search link if no specific URL available
                 const searchLink = `https://www.google.com/search?q=registro+electoral+oficial+${encodeURIComponent(countryName)}`;
                 linksContainer.append("a")
                    .attr("href", searchLink)
                    .attr("target", "_blank")
                    .text(`Buscar registro electoral`);
            }

            // --- Argentina Specific Section ---
            if (countryCode === "AR") {
                console.log("Country is Argentina, showing provinces section."); // Debugging log
                argentinaProvincesContainer.style("display", "block"); // Show section
                // Province dropdown is populated on load
            }

            // Show the panel using class for transition
            infoPanel.classed("visible", true);
            console.log("Info panel set to visible."); // Debugging log
        }

        // Hide the info panel visuals (doesn't reset state)
        function hideInfoPanel() {
            console.log("Hiding info panel visuals."); // Debugging log
            // Hide panel using class for transition
            infoPanel.classed("visible", false);

            // Clear Argentina specific fields when hiding visuals
            provinceSearchInput.property('value', '');
            provinceLinksContainer.html('');
            argentinaProvincesContainer.style("display", "none");

            // Clear time update interval
            clearInterval(localTimeInterval);
            localTimeEl.text(''); // Clear time text
        }

        // Reset globe view and hide info panel
        function resetView() {
             console.log("Resetting view."); // Debugging log
             const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
             const wasSelected = selectedCountryId !== null; // Check if a country *was* selected

             // Clear selection state *before* animation starts
             if (wasSelected) {
                 selectedCountryId = null; // Deselect country
                 renderGlobe(); // Re-render immediately to remove highlight before animation
             }

             // Hide the info panel visuals
             hideInfoPanel();

             // Clear search input
             searchInput.property("value", "");

             // Hide modal visuals
             hideModal();

             // Animate back to initial view
             rotateTo(initialRotation.x, initialRotation.y, baseScale);

             // Explicitly set controls-active to false when resetting the view
             body.classed("controls-active", false);


             // Clear time update interval (already done in hideInfoPanel, but safe to repeat)
             clearInterval(localTimeInterval);
             localTimeEl.text(''); // Clear time text
        }

        // Helper function to get flag emoji from ISO A2 country code
        function getFlagEmoji(countryCode) {
            if (!countryCode || typeof countryCode !== 'string' || countryCode.length !== 2) return '🏳️'; // Default flag
            // Ensure code is uppercase A-Z letters
            if (!/^[A-Z]{2}$/.test(countryCode)) return '🏳️';
            try {
                // Calculate regional indicator code points (e.g., 'U' + offset, 'S' + offset)
                const codePoints = countryCode.toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt(0));
                return String.fromCodePoint(...codePoints); // Create emoji string
            } catch (e) {
                console.error("Error creating flag emoji for code:", countryCode, e); // Debugging log
                return '🏳️'; // Fallback on error
            }
        }

        // Function to update province link based on code
        function updateProvinceLink(provinceCode) {
             provinceLinksContainer.html(''); // Clear previous province links
             const provinceInfo = argentinaProvincesData[provinceCode];

             if (provinceInfo) {
                 console.log("Province selected:", provinceInfo.name); // Debugging log
                 if (provinceInfo.url) {
                    // Show specific province link
                    provinceLinksContainer.append("a")
                        .attr("href", provinceInfo.url)
                        .attr("target", "_blank")
                        .text(`Padrón de ${provinceInfo.name}`);
                 } else {
                     // If no specific URL, show a message:
                     provinceLinksContainer.append("span")
                         .style("font-size", "0.8em")
                         .style("color", "#aaa")
                         .text(`Use el enlace nacional para ${provinceInfo.name}.`);
                 }
            } else {
                // If code is invalid (shouldn't happen with dropdown), clear the area
                 provinceLinksContainer.html('');
                 console.log("Invalid province code:", provinceCode); // Debugging log
            }
        }


        // --- Event Listeners ---

        // Handle focus on main country search input to show modal
        searchInput.on("focus", function() {
            console.log("Search input focused. Showing country modal."); // Debugging log
            // Ensure controls are active when input is focused
            body.classed("controls-active", true);
            // Get list of countries for modal
            const countriesForModal = searchableCountries.map(c => ({ id: c.id, nameEs: c.nameEs }));
            showModal("Buscar país", countriesForModal, 'country');
        });

        // Handle click on main country search input to show modal
         searchInput.on("click", function() {
             console.log("Search input clicked. Showing country modal."); // Debugging log
             // Ensure controls are active when input is clicked
             body.classed("controls-active", true);
             // Get list of countries for modal
             const countriesForModal = searchableCountries.map(c => ({ id: c.id, nameEs: c.nameEs }));
             showModal("Buscar país", countriesForModal, 'country');
         });

         // Handle blur on main search input
         searchInput.on("blur", function() {
             // Use a small timeout to allow clicks on modal buttons etc. before checking state
             setTimeout(() => {
                 // If the modal is hidden AND no country is selected AND the input is now blurred
                 if (!modalContainer.classed("visible") && selectedCountryId === null && document.activeElement !== searchInput.node()) {
                      body.classed("controls-active", false);
                 }
             }, 150); // Delay slightly
         });


        // Handle focus on province search input (for Argentina) to show modal
        provinceSearchInput.on("focus", function() {
             console.log("Province search input focused. Showing province modal."); // Debugging log
             // Ensure main controls stay active (should already be if Argentina is selected)
             body.classed("controls-active", true); // Ensure it stays active
            // Get list of provinces for modal
            const provincesForModal = Object.entries(argentinaProvincesData)
                                      .map(([code, info]) => ({ code: code, name: info.name }))
                                      .sort((a, b) => a.name.localeCompare(b.name));
            showModal("Buscar provincia", provincesForModal, 'province');
        });

         // Handle click on province search input to show modal
         provinceSearchInput.on("click", function() {
             console.log("Province search input clicked. Showing province modal."); // Debugging log
             // Ensure main controls stay active
             body.classed("controls-active", true); // Ensure it stays active
             // Get list of provinces for modal
             const provincesForModal = Object.entries(argentinaProvincesData)
                                       .map(([code, info]) => ({ code: code, name: info.name }))
                                       .sort((a, b) => a.name.localeCompare(b.name));
             showModal("Buscar provincia", provincesForModal, 'province');
         });

         // Handle blur on province search input
         provinceSearchInput.on("blur", function() {
             // Use a small timeout
             setTimeout(() => {
                 // If the modal is hidden AND the input is now blurred
                 // No need to change controls-active based on province input blur
                 if (!modalContainer.classed("visible") && document.activeElement !== provinceSearchInput.node()) {
                     // console.log("Province input blurred");
                 }
             }, 150);
         });


        // Handle click on modal close button
        modalCloseButton.on("click", hideModal);

        // Handle click on modal background to close it
        modalBackground.on("click", hideModal);


        // Handle click on a country feature on the globe (handler attached in setupGlobe)

        // Handle click on globe background (water/space) - acts as reset (handler attached in setupGlobe)

        // Handle window resize
        function handleResize() {
            console.log("Resizing window...");
            // Re-setup globe dimensions and projection
            setupGlobe();

            // If a country was selected, try to re-center and re-zoom
            if (selectedCountryId !== null) { // Check if a country is selected
                 const countryFeature = topojsonFeatures.find(f => parseInt(f.id, 10) === selectedCountryId); // Corrected ID comparison
                 // Ensure selected country is still in our data after resize
                 if (countryFeature && countriesData.find(c => c.id === selectedCountryId)) { // Check against countriesData
                    const centroid = d3.geoCentroid(countryFeature);
                     if (centroid && Array.isArray(centroid) && !centroid.some(isNaN)) {
                         const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
                         const targetScale = baseScale * 2.5;
                         const targetRotation = { x: -centroid[0], y: -centroid[1], z: currentRotation.z };
                         // Immediately set new rotation and scale without animation on resize
                         currentRotation = { x: targetRotation.x, y: targetRotation.y, z: currentRotation.z };
                         projection.scale(targetScale);
                         projection.rotate([currentRotation.x, currentRotation.y, currentRotation.z]);
                         renderGlobe(); // Re-render with new settings
                         // Ensure info panel remains visible if it was open
                         if (infoPanel.classed("visible")) {
                             updateInfoPanel(selectedCountryId); // Refresh panel content if needed
                         }
                     } else {
                          console.warn("Invalid centroid after resize, resetting view.");
                          resetView();
                     }
                 } else {
                      console.warn("Selected country feature not found or not in data after resize, resetting view.");
                      resetView();
                 }
            } else {
                // Just re-render if no country is selected
                renderGlobe();
            }
         }

        // Handle resize event with debounce
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 250); // Wait 250ms after last resize event
        });

        // --- Initialization ---
        loadData(); // Start data loading when script runs

        // Ensure modal is hidden on page load with a slight delay
        window.addEventListener('load', () => {
            setTimeout(hideModal, 50); // Add small delay (50ms)
        });

    </script>
</body>
</html>
