<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="shortcut icon" href="icon.png">
    <title>Consulta Global</title>
    <style>
        body {
            font-family: sans-serif;
			-webkit-tap-highlight-color: transparent;
            margin: 0;
            padding: 0;
            background-color: #000000; /* Fondo negro */
            color: #f0f0f0; /* Color de texto claro */
            display: flex;
            flex-direction: column; /* Layout en columna */
            align-items: center; /* Centrar horizontalmente */
            justify-content: flex-start; /* Alinear al inicio */
            height: 100vh;
            overflow: hidden; /* Evitar scrollbars */
            position: relative;
        }

        /* --- LOADER STYLES (NUEVO) --- */
        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000000;
            z-index: 9999; /* Por encima de todo */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transition: opacity 0.5s ease-out, visibility 0.5s ease-out;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #00ffff;
            animation: spin 1s ease-in-out infinite;
            margin-bottom: 15px;
        }

        .loading-text {
            color: #00ffff;
            font-size: 1.2em;
            letter-spacing: 2px;
            animation: pulse 1.5s infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        /* Clase para ocultar el loader */
        #loader.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
        }
        /* --- FIN LOADER STYLES --- */

        /* Contenedor principal para el t√≠tulo y controles */
        #header-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: top 0.7s ease-in-out, transform 0.7s ease-in-out, margin-top 0.7s ease-in-out;
            z-index: 20;
            background-color: transparent;
            width: auto;
            max-width: 95%;
            padding: 10px;
            box-sizing: border-box;
        }

        #title-container {
            margin-bottom: 20px;
            transition: opacity 0.6s ease-in-out, transform 0.6s ease-in-out;
            pointer-events: none;
            text-align: center;
            flex-shrink: 0;
            opacity: 1;
            transform: translateY(0);
        }

        #main-title {
            font-size: 2.5em;
            font-weight: bold;
            color: #00ffff;
            text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
            margin: 0;
        }

        body.controls-active #header-content {
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            margin-top: 0;
            width: 95%;
        }

        body.controls-active #title-container {
            opacity: 0;
            transform: translateY(-25px);
            pointer-events: none;
        }

        #controls {
            padding: 0;
            background-color: transparent;
            backdrop-filter: none;
            border-radius: 5px;
            box-shadow: none;
            display: flex;
            gap: 10px;
            align-items: center;
            border: none;
            position: relative;
            width: 100%;
            justify-content: center;
        }

        #search {
            padding: 12px 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background-color: rgba(255, 255, 255, 0);
            color: #f0f0f0;
            border-radius: 30px;
            font-size: 1.1em;
            outline: none;
            transition: background-color 0.3s ease, box-shadow 0.3s ease, width 0.3s ease, border-color 0.3s ease;
            width: 250px;
            text-align: center;
            cursor: pointer;
            box-sizing: border-box;
        }

        #search::placeholder {
            color: #aaa;
            text-align: center;
        }

         #search:not(:placeholder-shown) {
             text-align: left;
             background-color: rgba(255, 255, 255, 0.3);
         }

        #search:focus {
            background-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 0 12px rgba(0, 255, 255, 0.8);
            border-color: #00ffff;
            width: 300px;
            text-align: left;
        }

        #globe-container {
            flex-grow: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        #globe {
            max-width: 100%;
            max-height: 100%;
        }

        .land {
            fill: #444;
            stroke: #222;
            stroke-width: 0.4px;
            transition: fill 0.2s ease;
            cursor: default;
        }

        .land.data-available {
            fill: #b8b8b8;
            stroke: #444;
            cursor: pointer;
        }

        .land:not(.data-available):hover {
             fill: #555;
        }

        .land.data-available:hover {
            fill: #cccccc;
        }

        .land.selected {
            fill: #00ffff;
             stroke: #fff;
             stroke-width: 0.6px;
        }

        .water {
             fill: #0077be;
             filter: url(#ocean-glow);
        }

        #info-panel {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background-color: rgba(0, 0, 20, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            max-width: 250px;
            z-index: 10;
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            color: #e0e0e0;
            transform: translateY(10px);
            opacity: 0;
            display: none;
            flex-direction: column;
            align-items: center;
        }

        #info-panel.visible {
             opacity: 1;
             transform: translateY(0);
             display: flex;
        }

        #country-header {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            padding-bottom: 10px;
            text-align: center;
        }

        #country-name {
            margin: 0 0 5px 0;
            font-size: 1.4em;
            font-weight: bold;
            color: #fff;
            word-break: break-word;
        }

        #local-time {
            font-size: 1em;
            color: #00ffff;
            font-weight: bold;
            margin: 0;
            text-align: center;
            padding: 4px 8px;
            background-color: rgba(0, 255, 255, 0.1);
            border-radius: 4px;
        }

        #flag-container {
            margin-bottom: 15px;
            text-align: center;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 10px;
            width: 100%;
        }
         #flag-container img {
            max-width: 80px;
            max-height: 50px;
            height: auto;
            border: 1px solid rgba(255,255,255,0.3);
            background-color: rgba(255,255,255,0.1);
            object-fit: contain;
         }
         #flag-container span {
            font-size: 40px;
         }

        #links-container {
             width: 100%;
             text-align: center;
        }
        #links-container a {
            display: block;
            margin-bottom: 8px;
            color: #66bfff;
            text-decoration: none;
            font-size: 0.9em;
            word-wrap: break-word;
        }

        #links-container a:hover {
            text-decoration: underline;
            color: #99dfff;
        }

        #argentina-provinces {
            margin-top: 15px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            display: none;
            width: 100%;
        }

        #province-search-container {
            margin-bottom: 10px;
            position: relative;
            width: 100%;
        }

        #province-search-container label {
             display: block;
             margin-bottom: 5px;
             font-weight: bold;
             font-size: 0.9em;
             color: #ccc;
             text-align: left;
        }

        #province-search {
            width: 100%;
            padding: 10px 8px;
            border: 1px solid #555;
            border-radius: 3px;
            background-color: rgba(0,0,0, 0.3);
            color: #f0f0f0;
            outline: none;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
            box-sizing: border-box;
            font-size: 0.9em;
        }
        #province-search option {
             background-color: #222;
             color: #f0f0f0;
        }

        #province-search:focus {
             border-color: #007bff;
             box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        #province-links-container {
            min-height: 20px;
            margin-bottom: 10px;
            width: 100%;
            text-align: center;
        }

        #province-links-container a {
            display: block;
            margin-bottom: 8px;
            color: #66bfff;
            text-decoration: none;
            font-size: 0.9em;
            word-wrap: break-word;
        }

        #province-links-container a:hover {
            text-decoration: underline;
            color: #99dfff;
        }

        .national-links {
             width: 100%;
             text-align: center;
        }
        .national-links h3 {
            margin-top: 0;
            margin-bottom: 8px;
            font-size: 1em;
            color: #ddd;
        }

        .national-links a {
            display: block;
            margin-bottom: 8px;
            color: #66bfff;
            text-decoration: none;
            font-size: 0.9em;
        }
        .national-links a:hover {
            text-decoration: underline;
            color: #99dfff;
        }

        #modal-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 30;
            display: none;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0;
        }
        #modal-background.visible {
            display: block;
            opacity: 1;
        }

        #modal-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            background-color: rgba(30, 30, 30, 0.98);
            border: 1px solid #00ffff;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.4);
            z-index: 40;
            display: none;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            box-sizing: border-box;
            flex-direction: column;
            gap: 15px;
            transition: opacity 0.3s ease, transform 0.3s ease;
            opacity: 0;
        }
        #modal-container.visible {
             display: flex;
             opacity: 1;
             transform: translate(-50%, -50%) scale(1);
        }

        #modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 10px;
        }

        #modal-title {
            margin: 0;
            font-size: 1.3em;
            color: #fff;
        }

        #modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0;
            transition: color 0.2s ease;
        }

        #modal-close:hover {
            color: #ff0000;
        }

        #modal-search-input {
            width: 100%;
            padding: 10px 15px;
            border: 1px solid #555;
            border-radius: 5px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #f0f0f0;
            outline: none;
            box-sizing: border-box;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
        }

        #modal-search-input:focus {
            border-color: #007bff;
            box-shadow: 0 0 8px rgba(0, 123, 255, 0.5);
        }

        #modal-list.dropdown-list {
            flex-grow: 1;
            max-height: 200px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 5px;
            padding: 0;
            border: none;
            background-color: transparent;
            box-shadow: none;
        }

        #modal-list.dropdown-list button {
            display: block;
            width: 100%;
            padding: 10px 15px;
            color: #f0f0f0;
            background-color: transparent;
            border: none;
            text-align: left;
            cursor: pointer;
            transition: background-color 0.2s ease, color 0.2s ease;
            font-size: 1em;
            border-radius: 5px;
        }

        #modal-list.dropdown-list button:hover {
            background-color: rgba(0, 123, 255, 0.4);
            color: #ffffff;
        }


        /* Ajustes responsivos */
        @media (max-width: 600px) {
            #header-content {
                width: 95%;
                padding: 10px;
                flex-direction: column;
                align-items: center;
                max-width: 100%;
            }

            #title-container {
                margin-bottom: 10px;
                margin-right: 0;
                text-align: center;
                width: 100%;
            }

            #main-title {
                font-size: 1.5em;
                white-space: normal;
                overflow: visible;
                text-overflow: clip;
                max-width: 100%;
            }

            #controls {
                flex-direction: column;
                align-items: stretch;
                gap: 5px;
                width: 100%;
                flex-grow: 0;
                justify-content: center;
            }

            #search {
                 width: 100%;
                 flex-grow: 0;
                 max-width: none;
                 font-size: 0.9em;
                 padding: 8px 12px;
                 text-align: center;
            }
             #search::placeholder {
                 text-align: center;
             }

            #search:focus {
                 width: 100%;
                 max-width: none;
                 text-align: left;
            }

             body.controls-active #header-content {
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 95%;
                flex-direction: column;
                align-items: center;
                justify-content: center;
             }

             body.controls-active #title-container {
                 display: none;
             }

            #info-panel {
                bottom: 10px;
                right: 10px;
                left: 10px;
                max-width: none;
                width: auto;
                padding: 15px; /* Un poco m√°s de padding para que respire */
                align-items: center;
            }

            /* --- MODIFICACI√ìN M√ìVIL PARA PA√çS Y HORA --- */
            #country-header {
                flex-direction: row; /* Cambiado de column a row */
                justify-content: space-between; /* Extremos opuestos */
                align-items: center; /* Alineaci√≥n vertical */
                padding-bottom: 8px;
                margin-bottom: 8px;
                width: 100%;
            }

            #country-name {
                font-size: 1.2em;
                margin-bottom: 0; /* Sin margen inferior */
                text-align: left; /* Alinear a la izquierda */
                flex: 1; /* Que ocupe espacio disponible */
                margin-right: 10px; /* Separaci√≥n con la hora */
            }

            #local-time {
                font-size: 0.9em;
                padding: 4px 8px;
                margin: 0;
                white-space: nowrap; /* Que no se rompa la l√≠nea de la hora */
            }
            /* --- FIN MODIFICACI√ìN --- */

            #flag-container {
                height: 40px;
                margin-bottom: 10px;
            }
             #flag-container img {
                max-width: 60px;
                max-height: 40px;
             }
             #flag-container span {
                font-size: 30px;
             }

            #links-container a,
            #province-links-container a,
            #argentina-provinces label,
            #province-search,
            .national-links h3,
            .national-links a {
                font-size: 0.8em;
            }

             #modal-container {
                 width: 95%;
                 padding: 15px;
             }

             #modal-title {
                 font-size: 1.2em;
             }

             #modal-search-input {
                 padding: 8px 12px;
             }

             #modal-list.dropdown-list button {
                 padding: 8px 12px;
                 font-size: 0.9em;
             }
        }

    </style>
    <script type="importmap">
        {
            "imports": {
                "d3": "https://cdn.jsdelivr.net/npm/d3@7/+esm",
                "topojson-client": "https://cdn.jsdelivr.net/npm/topojson-client@3/+esm",
                "gsap": "https://cdn.jsdelivr.net/npm/gsap@3/+esm"
            }
        }
    </script>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <div class="loading-text">CARGANDO...</div>
    </div>

    <div id="header-content">
        <div id="title-container">
            <h1 id="main-title">¬øD√≥nde Voto?</h1>
        </div>
        <div id="controls">
            <input type="text" id="search" placeholder="Buscar Pa√≠s..." readonly>
            </div>
    </div>

    <div id="globe-container">
        <svg id="globe"></svg>
    </div>

    <div id="info-panel">
        <div id="country-header">
            <h2 id="country-name"></h2>
            <div id="local-time"></div>
        </div>
        <div id="flag-container"></div>
        <div style="text-align:center;" id="links-container"></div>

        <div id="argentina-provinces">
            <div id="province-search-container">
                <label for="province-search">Provincia:</label>
                <select id="province-search">
                    <option value="" disabled selected>Seleccione una provincia...</option>
                    </select>
            </div>

            <div style="text-align:center;" id="province-links-container"></div>

			 <div style="text-align:center;" class="national-links">
                 <a href="https://infractores.padron.gob.ar/" target="_blank">Registro de Infractores</a>
            </div>
        </div>
    </div>

    <div id="modal-background"></div>
    <div id="modal-container">
        <div id="modal-header">
            <h3 id="modal-title"></h3>
            <button id="modal-close">√ó</button>
        </div>
        <input type="text" id="modal-search-input" placeholder="Buscar...">
        <div id="modal-list" class="dropdown-list">
            </div>
    </div>
    <script type="module">
        import * as d3 from 'd3';
        import * as topojson from 'topojson-client';
        import { gsap } from 'gsap';

        // --- Data ---

        // Data for countries including flag URLs and electoral links
        // Only countries in this list will be interactive and have data displayed.
        const countriesData = [
          { id: 32, name: "Argentina", nameEs: "Argentina", lat: -34.6037, lon: -58.3816, code: "AR", electoralUrl: "https://www.padron.gob.ar/", flagUrl: "https://flagcdn.com/w80/ar.png", timezone: "America/Argentina/Buenos_Aires" },
          { id: 840, name: "United States", nameEs: "Estados Unidos", lat: 37.0902, lon: -95.7129, code: "US", electoralUrl: "https://www.usa.gov/register-to-vote", flagUrl: "https://flagcdn.com/w80/us.png", timezone: "America/New_York" }, 
          { id: 76, name: "Brazil", nameEs: "Brasil", lat: -15.7801, lon: -47.9292, code: "BR", electoralUrl: "https://www.tse.jus.br/eleitor/titulo-e-local-de-votacao/consulta-por-nome", flagUrl: "https://flagcdn.com/w80/br.png", timezone: "America/Sao_Paulo" }, 
          { id: 124, name: "Canada", nameEs: "Canad√°", lat: 56.1304, lon: -106.3468, code: "CA", electoralUrl: "https://www.elections.ca/content.aspx?section=vot&dir=reg&document=index&lang=e", flagUrl: "https://flagcdn.com/w80/ca.png", timezone: "America/Toronto" }, 
          { id: 484, name: "Mexico", nameEs: "M√©xico", lat: 23.6345, lon: -102.5528, code: "MX", electoralUrl: "https://listanominal.ine.mx/", flagUrl: "https://flagcdn.com/w80/mx.png", timezone: "America/Mexico_City" }, 
          { id: 826, name: "United Kingdom", nameEs: "Reino Unido", lat: 55.3781, lon: -3.4360, code: "GB", electoralUrl: "https://www.gov.uk/register-to-vote", flagUrl: "https://flagcdn.com/w80/gb.png", timezone: "Europe/London" },
          { id: 250, name: "France", nameEs: "Francia", lat: 46.2276, lon: 2.2137, code: "FR", electoralUrl: "https://www.service-public.fr/particuliers/vosdroits/R16396", flagUrl: "https://flagcdn.com/w80/fr.png", timezone: "Europe/Paris" },
          { id: 276, name: "Germany", nameEs: "Alemania", lat: 51.1657, lon: 10.4515, code: "DE", electoralUrl: "https://www.bundeswahlleiter.de/en/bundestagswahlen/2021.html", flagUrl: "https://flagcdn.com/w80/de.png", timezone: "Europe/Berlin" },
          { id: 724, name: "Spain", nameEs: "Espa√±a", lat: 40.4637, lon: -3.7492, code: "ES", electoralUrl: "https://sede.ine.gob.es/consulta_electoral_elecciones", flagUrl: "https://flagcdn.com/w80/es.png", timezone: "Europe/Madrid" },
          { id: 380, name: "Italy", nameEs: "Italia", lat: 41.8719, lon: 12.5674, code: "IT", electoralUrl: "https://dait.interno.gov.it/elezioni", flagUrl: "https://flagcdn.com/w80/it.png", timezone: "Europe/Rome" },
          { id: 36, name: "Australia", nameEs: "Australia", lat: -25.2744, lon: 133.7751, code: "AU", electoralUrl: "https://www.aec.gov.au/check-enrolment/", flagUrl: "https://flagcdn.com/w80/au.png", timezone: "Australia/Sydney" }, 
          { id: 392, name: "Japan", nameEs: "Jap√≥n", lat: 36.2048, lon: 138.2529, code: "JP", electoralUrl: "https://www.soumu.go.jp/senkyo/index.html", flagUrl: "https://flagcdn.com/w80/jp.png", timezone: "Asia/Tokyo" },
          { id: 356, name: "India", nameEs: "India", lat: 20.5937, lon: 78.9629, code: "IN", electoralUrl: "https://electoralsearch.in/", flagUrl: "https://flagcdn.com/w80/in.png", timezone: "Asia/Kolkata" }, 
          { id: 156, name: "China", nameEs: "China", lat: 35.8617, lon: 104.1954, code: "CN", electoralUrl: "http://www.npc.gov.cn/englishnpc/c23934/column.shtml", flagUrl: "https://flagcdn.com/w80/cn.png", timezone: "Asia/Shanghai" }, 
          { id: 643, name: "Russia", nameEs: "Rusia", lat: 61.5240, lon: 105.3188, code: "RU", electoralUrl: "http://www.cikrf.ru/", flagUrl: "https://flagcdn.com/w80/ru.png", timezone: "Europe/Moscow" }, 
          { id: 710, name: "South Africa", nameEs: "Sud√°frica", lat: -30.5595, lon: 22.9375, code: "ZA", electoralUrl: "https://www.elections.org.za/pw/Voter/Voter-Information", flagUrl: "https://flagcdn.com/w80/za.png", timezone: "Africa/Johannesburg" },
          { id: 152, name: "Chile", nameEs: "Chile", lat: -35.6751, lon: -71.5430, code: "CL", electoralUrl: "https://consulta.servel.cl/", flagUrl: "https://flagcdn.com/w80/cl.png", timezone: "America/Santiago" },
          { id: 170, name: "Colombia", nameEs: "Colombia", lat: 4.5709, lon: -74.2973, code: "CO", electoralUrl: "https://wsp.registraduria.gov.co/censo/_censoResultado.php", flagUrl: "https://flagcdn.com/w80/co.png", timezone: "America/Bogota" },
          { id: 818, name: "Egypt", nameEs: "Egipto", lat: 26.8206, lon: 30.8025, code: "EG", electoralUrl: "https://www.elections.eg/", flagUrl: "https://flagcdn.com/w80/eg.png", timezone: "Africa/Cairo" },
          { id: 566, name: "Nigeria", nameEs: "Nigeria", lat: 9.0820, lon: 8.6753, code: "NG", electoralUrl: "https://inecnigeria.org/", flagUrl: "https://flagcdn.com/w80/ng.png", timezone: "Africa/Lagos" },
          { id: 68, name: "Bolivia", nameEs: "Bolivia", lat: -16.2902, lon: -63.5887, code: "BO", electoralUrl: "https://yoparticipo.oep.org.bo/", flagUrl: "https://flagcdn.com/w80/bo.png", timezone: "America/La_Paz" },
          { id: 600, name: "Paraguay", nameEs: "Paraguay", lat: -23.4425, lon: -58.4438, code: "PY", electoralUrl: "https://rcp.tsje.gov.py/", flagUrl: "https://flagcdn.com/w80/py.png", timezone: "America/Asuncion" },
          { id: 858, name: "Uruguay", nameEs: "Uruguay", lat: -32.5228, lon: -55.7658, code: "UY", electoralUrl: "https://aplicaciones.corteelectoral.gub.uy/buscadorpermanente/buscadores.buscadorpermanente.aspx", flagUrl: "https://flagcdn.com/w80/uy.png", timezone: "America/Montevideo" }
        ];

        // Data for Argentina provinces and their electoral links
        const argentinaProvincesData = {
          'buenos-aires': { name: 'Buenos Aires', url: 'https://dondevotociudad.gob.ar/' },
          'caba': { name: 'CABA', url: 'https://caba.padron.gov.ar/' },
          'catamarca': { name: 'Catamarca', url: 'https://www.eleccionescatamarca.gob.ar/' },
          'chaco': { name: 'Chaco', url: 'https://padron.electoralchaco.gob.ar/consulta' },
          'chubut': { name: 'Chubut', url: 'https://electoral.juschubut.gov.ar/' },
          'cordoba': { name: 'C√≥rdoba', url: 'https://elepcba.com.ar/' },
          'corrientes': { name: 'Corrientes', url: 'https://www.juscorrientes.gov.ar/junta-electoral/' },
          'entre-rios': { name: 'Entre R√≠os', url: 'https://www.tribunalelectoraler.gob.ar/' },
          'formosa': { name: 'Formosa', url: 'https://padron.formosa.gob.ar/' },
          'jujuy': { name: 'Jujuy', url: 'https://www.padronjujuy.gob.ar/' },
          'la-pampa': { name: 'La Pampa', url: 'https://electoral.justicialapampa.gob.ar/definitivo/atencion.aspx' },
          'la-rioja': { name: 'La Rioja', url: 'https://larioja.padron.gov.ar/' },
          'mendoza': { name: 'Mendoza', url: 'https://www.mendoza.gov.ar/padron/' },
          'misiones': { name: 'Misiones', url: 'https://www.electoralmisiones.gov.ar/' },
          'neuquen': { name: 'Neuqu√©n', url: 'https://www.muninqn.gov.ar/padron/' },
          'rio-negro': { name: 'R√≠o Negro', url: 'https://rionegro.padron.gov.ar/' },
          'salta': { name: 'Salta', url: 'https://www.electoralsalta.gob.ar/electores/consulta-lugar-votacion' },
          'san-juan': { name: 'San Juan', url: 'https://www.padron.gob.ar/' },
          'san-luis': { name: 'San Luis', url: 'https://sanluis.padron.gov.ar/' },
          'santa-cruz': { name: 'Santa Cruz', url: 'https://educacionsantacruz.gov.ar/juntaelectoral/' },
          'santa-fe': { name: 'Santa Fe', url: 'https://www.santafe.gov.ar/elecciones2025/consultaPadronDefinitivo/' },
          'santiago-del-estero': { name: 'Santiago del Estero', url: 'https://www.jussantiago.gov.ar/web/#/home' },
          'tucuman': { name: 'Tucum√°n', url: 'https://electoraltucuman.gob.ar/' },
          'tierra-del-fuego': { name: 'Tierra del Fuego', url: 'https://padron.justierradelfuego.gov.ar/elecciones/padron-definitivo' }
        };

        // --- DOM Elements ---
        const body = d3.select("body"); 
        const svg = d3.select("#globe");
        const infoPanel = d3.select("#info-panel");
        const countryNameEl = d3.select("#country-name");
        const localTimeEl = d3.select("#local-time"); 
        const flagContainer = d3.select("#flag-container"); 
        const linksContainer = d3.select("#links-container");
        const argentinaProvincesContainer = d3.select("#argentina-provinces");
        const provinceLinksContainer = d3.select("#province-links-container");
        const searchInput = d3.select("#search");
        const controlsDiv = d3.select("#controls"); 
        const globeContainer = d3.select("#globe-container");
        const provinceSearchInput = d3.select("#province-search"); 
        const provinceSearchContainer = d3.select("#province-search-container"); 
        const titleContainer = d3.select("#title-container"); 
        const headerContentDiv = d3.select("#header-content"); 
        // Loader element
        const loader = d3.select("#loader");

        // Modal Elements
        const modalBackground = d3.select("#modal-background");
        const modalContainer = d3.select("#modal-container");
        const modalTitle = d3.select("#modal-title");
        const modalCloseButton = d3.select("#modal-close");
        const modalSearchInput = d3.select("#modal-search-input");
        const modalList = d3.select("#modal-list"); 

        // --- Globe State ---
        let width, height, projection, path, graticule, sphere, zoom, drag;
        let topojsonFeatures;
        const initialScaleFactor = 0.9;
        const initialRotation = { x: 70, y: -25, z: 0 }; 
        let currentRotation = { ...initialRotation };
        let searchableCountries = []; 
        let selectedCountryId = null;
        let localTimeInterval = null; 
        let currentTween = null; 

        // --- Globe Setup and Rendering ---

        function setupGlobe() {
            const containerRect = globeContainer.node().getBoundingClientRect();
            width = containerRect.width;
            height = containerRect.height;
            width = Math.max(width, 300); 
            height = Math.max(height, 300);

            svg.attr("width", width).attr("height", height);

            const effectiveScale = Math.min(width, height) / 2 * initialScaleFactor;

            projection = d3.geoOrthographic()
                .scale(effectiveScale)
                .translate([width / 2, height / 2])
                .rotate([currentRotation.x, currentRotation.y, currentRotation.z]) 
                .clipAngle(90);

            path = d3.geoPath().projection(projection);
            graticule = d3.geoGraticule10();

            zoom = d3.zoom().scaleExtent([1, 8]).on("zoom", null); 

            drag = d3.drag()
                .subject(() => {
                    if (currentTween) {
                        currentTween.kill();
                        currentTween = null;
                    }
                    const r = projection.rotate();
                    const sensFactor = projection.scale() / effectiveScale;
                    const sens = 0.25 / Math.max(sensFactor, 0.5); 
                    return { x: r[0] / sens, y: -r[1] / sens, sens: sens };
                })
                .on("start", (event) => {
                    event.sourceEvent.stopPropagation();
                    if (infoPanel.classed("visible")) {
                         hideInfoPanel(); 
                    }
                })
                .on("drag", (event) => {
                    if (!event.active) return;
                    const rotate = projection.rotate();
                    const sens = event.subject.sens;
                    const newRotation = {
                        x: rotate[0] + event.dx * sens,
                        y: rotate[1] - event.dy * sens,
                        z: rotate[2]
                    };
                    newRotation.y = Math.max(-85, Math.min(85, newRotation.y)); 
                    projection.rotate([newRotation.x, newRotation.y, newRotation.z]);
                    currentRotation = newRotation; 
                    renderGlobe(); 
                });

            svg.call(drag);
            svg.call(zoom);
            svg.on("click", handleBackgroundClick); 

            svg.selectAll("*").remove();

            const defs = svg.append("defs");
            const filter = defs.append("filter").attr("id", "ocean-glow");
            filter.append("feGaussianBlur").attr("stdDeviation", "1.5").attr("result", "coloredBlur"); 
            const feMerge = filter.append("feMerge");
            feMerge.append("feMergeNode").attr("in", "coloredBlur");
            feMerge.append("feMergeNode").attr("in", "SourceGraphic");

            svg.append("path")
                .datum({type: "Sphere"})
                .attr("id", "sphere")
                .attr("class", "water");

            svg.append("path")
                .datum(graticule)
                .attr("class", "graticule")
                .attr("fill", "none")
                .attr("stroke", "rgba(128,128,128,0.2)")
                .attr("stroke-width", 0.5);

            svg.append("g").attr("class", "land-features");

            renderGlobe();
        }

        function renderGlobe() {
            if (!path || !topojsonFeatures) return;

            projection.scale(projection.scale());
            projection.rotate([currentRotation.x, currentRotation.y, currentRotation.z]);
            path = d3.geoPath().projection(projection);

            svg.select("#sphere").attr("d", path);
            svg.select(".graticule").attr("d", path);

            const filteredFeatures = topojsonFeatures.filter(d => d.id && d.id !== '010');

            const land = svg.select(".land-features")
                .selectAll("path.land")
                .data(filteredFeatures, d => d.id); 

            land.enter()
                .append("path")
                .attr("class", "land")
                .attr("d", path)
                .on("click", handleCountryClick) 
                .on("mouseover", function(event, d) {
                    if (getCountryInfo(d) || d3.select(this).classed("selected")) {
                    }
                 })
                .on("mouseout", function(event, d) {
                 })
                .append("title") 
                 .text(d => getCountryInfo(d)?.nameEs || d.properties?.name || `ID: ${d.id}`); 

            land.merge(land)
                 .classed("data-available", d => !!getCountryInfo(d)) 
                 .classed("selected", d => parseInt(d.id, 10) === selectedCountryId) 
                 .attr("d", path); 

            land.exit().remove();
        }

        // --- Data Loading and Processing ---

        async function loadData() {
            try {
                const world = await d3.json("https://unpkg.com/world-atlas@2/countries-110m.json");
                topojsonFeatures = topojson.feature(world, world.objects.countries).features;

                searchableCountries = topojsonFeatures
                    .map(d => {
                        const info = getCountryInfo(d);
                        if (info) { 
                            const name = info.nameEs || info.name; 
                            if (name) {
                                return { id: info.id, nameEs: name }; 
                            }
                        }
                        return null;
                    })
                    .filter(Boolean) 
                    .sort((a, b) => a.nameEs.localeCompare(b.nameEs)); 

                console.log("Data loaded and processed.");
                body.classed("controls-active", false);
                setupGlobe(); 
                
                // --- Ocultar Loader con transici√≥n suave al terminar la carga ---
                loader.classed("hidden", true);
                // Eliminar del DOM despu√©s de la transici√≥n para limpiar
                setTimeout(() => {
                    loader.remove();
                }, 500);

            } catch (error) {
                console.error("Error loading or processing data:", error);
                // Mostrar error en el loader si falla
                d3.select(".loading-text").text("ERROR AL CARGAR").style("color", "#ff0000");
                d3.select(".spinner").style("border-top-color", "#ff0000");
            }
        }

        function getCountryInfo(topojsonFeature) {
            if (!topojsonFeature || !topojsonFeature.id) return null;
            const id = parseInt(topojsonFeature.id, 10); 
            return countriesData.find(c => c.id === id);
        }

        // --- Modal Functions ---

        function showModal(title, data, itemType) {
            modalTitle.text(title);
            modalList.html(''); 
            modalSearchInput.property('value', ''); 

            const listItems = modalList.selectAll("button")
                .data(data)
                .enter()
                .append("button")
                .text(d => d.nameEs || d.name); 

            if (itemType === 'country') {
                listItems.attr("data-country-id", d => d.id) 
                    .on("click", function() {
                        const countryIdAttr = d3.select(this).attr("data-country-id");
                        const countryName = d3.select(this).text();
                        searchInput.property("value", countryName); 
                        hideModal(); 
                        selectCountry(parseInt(countryIdAttr, 10)); 
                    });
            } 

            modalSearchInput.on("input", function() {
                const query = d3.select(this).property("value").trim().toLowerCase();
                modalList.selectAll("button").each(function() {
                    const button = d3.select(this);
                    const itemName = button.text().toLowerCase();
                    if (itemName.includes(query)) {
                        button.style("display", "block");
                    } else {
                        button.style("display", "none");
                    }
                });
            });

            modalBackground.classed("visible", true);
            modalContainer.classed("visible", true);
            modalSearchInput.node().focus(); 

            body.classed("controls-active", true);
        }

        function hideModal() {
            modalBackground.classed("visible", false);
            modalContainer.classed("visible", false);
        }


        // --- Interaction Functions ---

        function handleCountryClick(event, d) {
             event.stopPropagation(); 

             const countryInfo = getCountryInfo(d);
             if (!countryInfo) {
                 console.log("Clicked on a country not in data:", d.properties?.name || d.id);
                 return;
             }

             body.classed("controls-active", true);

             if (d && d.id) {
                const clickedId = parseInt(d.id, 10);

                // --- CAMBIO AQU√ç ---
                // Si el ID clickeado es igual al que ya est√° seleccionado...
                if (clickedId === selectedCountryId) {
                    // ...simplemente actualizamos/abrimos el panel de nuevo y terminamos.
                    updateInfoPanel(clickedId);
                    return;
                }
                // -------------------

                selectCountry(countryInfo.id); 
                searchInput.property("value", countryInfo.nameEs || countryInfo.name);
             } 
        }

        function handleBackgroundClick(event) {
            if (event.target === svg.node() || event.target === svg.select("#sphere").node()) {
                resetView(); 
            }
        }

        function selectCountry(countryId) {
             const countryInfo = countriesData.find(c => c.id === countryId); 
             if (!countryInfo) {
                 return;
             }

             body.classed("controls-active", true);

             const countryFeature = topojsonFeatures.find(f => parseInt(f.id, 10) === countryId); 
             if (!countryFeature) {
                 updateInfoPanel(countryId); 
                 return; 
             }

             selectedCountryId = countryId; 
             renderGlobe(); 

             const centroid = d3.geoCentroid(countryFeature);
             if (!centroid || !Array.isArray(centroid) || centroid.some(isNaN)) {
                 updateInfoPanel(countryId); 
                 return; 
             }

             const targetRotation = { x: -centroid[0], y: -centroid[1] };
             const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
             const targetScale = baseScale * 2.5; 

             rotateTo(targetRotation.x, targetRotation.y, targetScale, () => {
                 updateInfoPanel(countryId); 
             });
        }

        function rotateTo(lon, lat, scale, onCompleteCallback = null) {
            if (currentTween) {
                currentTween.kill();
            }

            const currentScale = projection.scale();
            const currentRot = projection.rotate();

            const rotationProxy = { lon: currentRot[0], lat: currentRot[1], scale: currentScale };

            currentTween = gsap.to(rotationProxy, {
                lon: lon,
                lat: lat,
                scale: scale,
                duration: 1.5, 
                ease: "sine.inOut", 
                onUpdate: () => {
                     currentRotation = { x: rotationProxy.lon, y: rotationProxy.lat, z: currentRotation.z };
                     projection.scale(rotationProxy.scale);
                    renderGlobe();
                },
                onComplete: () => {
                     currentRotation = { x: lon, y: lat, z: currentRotation.z };
                     projection.scale(scale);
                    renderGlobe();
                    currentTween = null; 
                    if (onCompleteCallback) {
                        onCompleteCallback();
                    }
                }
            });
        }

        function updateInfoPanel(countryId) {
            const countryInfo = countriesData.find(c => c.id === countryId);
            if (!countryInfo) {
                hideInfoPanel(); 
                return;
            }

            const countryName = countryInfo.nameEs || countryInfo.name || "Pa√≠s Desconocido";
            const countryCode = countryInfo.code; 
            const timezone = countryInfo.timezone; 

            countryNameEl.text(countryName);

            clearInterval(localTimeInterval); 
            localTimeEl.text(''); 

            if (timezone) {
                const updateTime = () => {
                    try {
                        const now = new Date();
                        const options = {
                            hour: '2-digit',
                            minute: '2-digit',
                            hour12: true, 
                            timeZone: timezone
                        };
                        const formatter = new Intl.DateTimeFormat('es-ES', options);
                        localTimeEl.text(`${formatter.format(now)}`); 
                    } catch (e) {
                        console.error("Error formatting time for timezone:", timezone, e); 
                        localTimeEl.text(`N/A`); 
                    }
                };

                updateTime(); 
                localTimeInterval = setInterval(updateTime, 60000); 
            } else {
                localTimeEl.text(`N/A`); 
            }

            flagContainer.html(''); 
            if (countryInfo.flagUrl) {
                flagContainer.append('img')
                    .attr('src', countryInfo.flagUrl)
                    .attr('alt', `Bandera de ${countryName}`)
                    .on('error', function() {
                        d3.select(this).remove(); 
                        flagContainer.append('span').text(getFlagEmoji(countryCode)); 
                    });
            } else {
                flagContainer.append('span').text(getFlagEmoji(countryCode));
            }

            linksContainer.html(''); 
            argentinaProvincesContainer.style("display", "none"); 
            provinceLinksContainer.html(''); 
            provinceSearchInput.property('value', ''); 

            if (countryInfo.electoralUrl) {
                 linksContainer.append("a")
                    .attr("href", countryInfo.electoralUrl)
                    .attr("target", "_blank")
                    .text(`Registro Electoral`); 
            } else {
                 const searchLink = `https://www.google.com/search?q=registro+electoral+oficial+${encodeURIComponent(countryName)}`;
                 linksContainer.append("a")
                    .attr("href", searchLink)
                    .attr("target", "_blank")
                    .text(`Buscar registro electoral`);
            }

            if (countryCode === "AR") {
                argentinaProvincesContainer.style("display", "block"); 
                
                provinceSearchInput.selectAll("option:not(:first-child)").remove();
                
                const sortedProvinces = Object.entries(argentinaProvincesData)
                                          .map(([code, info]) => ({ code: code, name: info.name }))
                                          .sort((a, b) => a.name.localeCompare(b.name));

                sortedProvinces.forEach(province => {
                    provinceSearchInput.append("option")
                        .attr("value", province.code)
                        .text(province.name);
                });
                
                provinceSearchInput.property('value', '');
            }

            infoPanel.classed("visible", true);
        }

        function hideInfoPanel() {
            infoPanel.classed("visible", false);

            provinceSearchInput.property('value', '');
            provinceLinksContainer.html('');
            argentinaProvincesContainer.style("display", "none");

            clearInterval(localTimeInterval);
            localTimeEl.text(''); 
        }

        function resetView() {
             const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
             const wasSelected = selectedCountryId !== null; 

             if (wasSelected) {
                 selectedCountryId = null; 
                 renderGlobe(); 
             }

             hideInfoPanel();
             searchInput.property("value", "");
             hideModal();
             rotateTo(initialRotation.x, initialRotation.y, baseScale);
             body.classed("controls-active", false);
             clearInterval(localTimeInterval);
             localTimeEl.text(''); 
        }

        function getFlagEmoji(countryCode) {
            if (!countryCode || typeof countryCode !== 'string' || countryCode.length !== 2) return 'üè≥Ô∏è'; 
            if (!/^[A-Z]{2}$/.test(countryCode)) return 'üè≥Ô∏è';
            try {
                const codePoints = countryCode.toUpperCase()
                    .split('')
                    .map(char => 127397 + char.charCodeAt(0));
                return String.fromCodePoint(...codePoints); 
            } catch (e) {
                return 'üè≥Ô∏è'; 
            }
        }

        function updateProvinceLink(provinceCode) {
             provinceLinksContainer.html(''); 
             const provinceInfo = argentinaProvincesData[provinceCode];

             if (provinceInfo) {
                 if (provinceInfo.url) {
                    provinceLinksContainer.append("a")
                        .attr("href", provinceInfo.url)
                        .attr("target", "_blank")
                        .text(`Padr√≥n de ${provinceInfo.name}`);
                 } else {
                     provinceLinksContainer.append("span")
                         .style("font-size", "0.8em")
                         .style("color", "#aaa")
                         .text(`Use el enlace nacional para ${provinceInfo.name}.`);
                 }
            } else {
                 provinceLinksContainer.html('');
            }
        }


        // --- Event Listeners ---

        searchInput.on("focus", function() {
            body.classed("controls-active", true);
            const countriesForModal = searchableCountries.map(c => ({ id: c.id, nameEs: c.nameEs }));
            showModal("Buscar Pa√≠s", countriesForModal, 'country');
        });

         searchInput.on("click", function() {
             body.classed("controls-active", true);
             const countriesForModal = searchableCountries.map(c => ({ id: c.id, nameEs: c.nameEs }));
             showModal("Buscar Pa√≠s", countriesForModal, 'country');
         });

         searchInput.on("blur", function() {
             setTimeout(() => {
                 if (!modalContainer.classed("visible") && selectedCountryId === null && document.activeElement !== searchInput.node()) {
                      body.classed("controls-active", false);
                 }
             }, 150); 
         });


        provinceSearchInput.on("change", function() {
            const selectedCode = d3.select(this).property("value");
            if (selectedCode) {
                updateProvinceLink(selectedCode);
            } else {
                provinceLinksContainer.html(''); 
            }
        });


        modalCloseButton.on("click", hideModal);
        modalBackground.on("click", hideModal);

        function handleResize() {
            setupGlobe();

            if (selectedCountryId !== null) { 
                 const countryFeature = topojsonFeatures.find(f => parseInt(f.id, 10) === selectedCountryId); 
                 if (countryFeature && countriesData.find(c => c.id === selectedCountryId)) { 
                    const centroid = d3.geoCentroid(countryFeature);
                     if (centroid && Array.isArray(centroid) && !centroid.some(isNaN)) {
                         const baseScale = Math.min(width, height) / 2 * initialScaleFactor;
                         const targetScale = baseScale * 2.5;
                         const targetRotation = { x: -centroid[0], y: -centroid[1], z: currentRotation.z };
                         currentRotation = { x: targetRotation.x, y: targetRotation.y, z: currentRotation.z };
                         projection.scale(targetScale);
                         projection.rotate([currentRotation.x, currentRotation.y, currentRotation.z]);
                         renderGlobe(); 
                         if (infoPanel.classed("visible")) {
                             updateInfoPanel(selectedCountryId); 
                         }
                     } else {
                          resetView();
                     }
                 } else {
                      resetView();
                 }
            } else {
                renderGlobe();
            }
         }

        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(handleResize, 250); 
        });

        loadData(); 

        window.addEventListener('load', () => {
            setTimeout(hideModal, 50); 
        });

    </script>
</body>
</html>
